# 電子商務微服務交易編排系統 - 產品需求文件 (PRD)

> **版本**: 2.0  
> **建立日期**: 2026-01-01  
> **狀態**: Draft

---

## 1. 產品概述

### 1.1 背景

本系統為電子商務平台的核心交易處理系統，採用微服務架構處理訂單流程。當客戶下單購買商品（如 iPhone）時，系統需依序協調多個微服務完成交易，並確保分散式事務的一致性。

### 1.2 目標

- 實現可靠的分散式交易處理機制（Saga Pattern + Outbox Pattern）
- 確保跨微服務的資料一致性
- 提供完整的交易狀態追蹤與可觀測性
- 支援自動化的失敗補償與回滾機制
- 提供即時狀態通知（WebSocket）
- 支援動態配置服務順序與超時時間

### 1.3 範圍

本系統涵蓋以下四個核心微服務的交易編排：

| 微服務 | 職責 |
|--------|------|
| 訂單服務 (Order Service) | 接收客戶訂單，作為 Saga Orchestrator |
| 信用卡服務 (Credit Card Service) | 處理付款授權與扣款 |
| 倉管服務 (Inventory Service) | 處理庫存預留與扣減 |
| 物流服務 (Logistics Service) | 處理出貨排程與配送 |

---

## 2. 系統架構模式

### 2.1 核心設計模式

| 模式 | 說明 |
|------|------|
| Saga Pattern (Orchestration) | 由訂單服務作為編排器，控制交易流程 |
| Outbox Pattern | 確保 DB 寫入與訊息處理的原子性，採用異步模式 |
| Event Sourcing | 所有狀態變更以 INSERT 方式記錄，不做 UPDATE |

### 2.2 異步處理流程

```
┌──────────┐    POST /confirm    ┌──────────────────────────────────────┐
│  Client  │ ──────────────────► │           Order Service              │
└──────────┘                     │  ┌─────────────────────────────────┐ │
     ▲                           │  │ 1. 產生 TxID                    │ │
     │                           │  │ 2. 寫入 Outbox (DB Transaction) │ │
     │ 202 Accepted              │  │ 3. 啟動 Checker Thread          │ │
     │ + WebSocket 連線          │  └─────────────────────────────────┘ │
     │                           └──────────────────────────────────────┘
     │                                          │
     │                                          ▼
     │                           ┌──────────────────────────────────────┐
     │   WebSocket 推送          │        Outbox Poller (單一)          │
     │   狀態變更通知            │  ┌─────────────────────────────────┐ │
     ◄───────────────────────────│  │ 依序呼叫：                      │ │
                                 │  │ 信用卡 → 倉管 → 物流            │ │
                                 │  └─────────────────────────────────┘ │
                                 └──────────────────────────────────────┘
```

---

## 3. 使用者故事

### 3.1 主要流程 - 訂單成功

```
作為一個客戶
當我確認訂購 iPhone
我希望系統能依序完成付款、庫存預留、出貨排程
並透過 WebSocket 即時通知我每個步驟的進度
```

**驗收條件 (Acceptance Criteria)**:

```gherkin
Scenario: 訂單交易全部成功
  Given 客戶已登入系統
  And 購物車中有 1 台 iPhone
  And 客戶已建立 WebSocket 連線
  When 客戶確認訂購
  Then 系統回應 202 Accepted 並回傳 TxID
  And 系統寫入 Outbox 事件
  And 系統啟動專屬 Checker Thread 監控此交易
  And Outbox Poller 依序呼叫信用卡服務
  And WebSocket 推送「信用卡扣款成功」
  And Outbox Poller 呼叫倉管服務
  And WebSocket 推送「庫存預留成功」
  And Outbox Poller 呼叫物流服務
  And WebSocket 推送「出貨排程成功」
  And 交易狀態資料表記錄三個微服務狀態皆為 S
  And Checker Thread 停止
  And WebSocket 推送「訂單交易完成」
```

### 3.2 補償流程 - 部分失敗需回滾

```
作為系統
當交易流程中任一微服務失敗
我需要自動回滾已成功的微服務
並透過 WebSocket 通知客戶交易失敗
```

**驗收條件 (Acceptance Criteria)**:

```gherkin
Scenario: 倉管服務失敗觸發回滾
  Given 訂單已建立，TxID 為 "TX-001"
  And 信用卡服務已成功扣款（狀態 S）
  And 客戶已建立 WebSocket 連線
  When 倉管服務回應失敗
  Then 系統記錄倉管服務狀態為 F
  And WebSocket 推送「庫存預留失敗」
  And 系統呼叫信用卡服務的回滾 API（反向順序）
  And 系統記錄信用卡服務狀態為 R
  And 系統記錄狀態 D（Done，回滾流程完成）
  And Checker Thread 停止
  And WebSocket 推送「訂單交易失敗，已回滾」
```

### 3.3 超時處理 - 在途狀態超時

```
作為系統
當任一微服務處於在途狀態(U)超過設定時間
我需要主動觸發回滾機制
```

**驗收條件 (Acceptance Criteria)**:

```gherkin
Scenario: 在途狀態超時觸發回滾
  Given 訂單 TxID "TX-002" 的信用卡服務狀態為 S
  And 倉管服務狀態為 U
  And 倉管服務超時設定為 60 秒
  And 時間戳記已超過 60 秒
  When Checker Thread 偵測到超時
  Then 系統呼叫倉管服務的回滾 API
  And 系統記錄倉管服務狀態為 R
  And 系統呼叫信用卡服務的回滾 API（反向順序）
  And 系統記錄信用卡服務狀態為 R
  And 系統記錄狀態 D
  And Checker Thread 停止
```

### 3.4 回滾失敗處理

```
作為系統
當回滾 API 呼叫失敗超過重試次數
我需要記錄錯誤並通知管理人員
```

**驗收條件 (Acceptance Criteria)**:

```gherkin
Scenario: 回滾失敗通知
  Given 訂單 TxID "TX-003" 需要回滾信用卡服務
  And 回滾 API 連續失敗 5 次
  When 重試次數達到上限
  Then 系統記錄信用卡服務狀態為 RF
  And 系統記錄錯誤訊息
  And 系統發送 Email 通知管理人員
  And 系統記錄通知時間 (notified_at)
```

### 3.5 服務恢復處理

```
作為系統
當訂單服務重啟
我需要自動恢復未完成的交易
```

**驗收條件 (Acceptance Criteria)**:

```gherkin
Scenario: 服務重啟後恢復 Saga
  Given 系統中有未完成的交易（狀態非 全S / D / RF）
  When 訂單服務重新啟動
  Then 系統掃描所有未完成交易
  And 為每筆交易重新啟動 Checker Thread
  And 繼續執行或回滾流程
```

---

## 4. 功能需求

### 4.1 交易編排功能 (Apache Camel Route)

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-001 | 訂單確認 API | 接收客戶訂單確認請求，產生唯一 TxID，回應 202 Accepted |
| FR-002 | Outbox 寫入 | 將交易事件寫入 Outbox 表（與業務資料同一 Transaction） |
| FR-003 | Outbox Poller | 單一 Poller 從訂單服務讀取並處理 Outbox 事件 |
| FR-004 | 順序呼叫控制 | 依可配置順序呼叫微服務（預設：信用卡 → 倉管 → 物流） |
| FR-005 | 回應等待機制 | 每個微服務正確回應後才呼叫下一個 |
| FR-006 | 失敗回滾觸發 | 任一微服務失敗時，觸發補償流程 |

### 4.2 Checker Thread 功能

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-007 | Thread 啟動 | 每筆訂單觸發時啟動專屬 Checker Thread |
| FR-008 | 成功監控 | 三個微服務皆為 S 時，Thread 停止 |
| FR-009 | 失敗監控 | 任一微服務為 F 時，觸發回滾，完成後記錄 D，Thread 停止 |
| FR-010 | 超時監控 | 任一微服務 U 狀態超過設定時間，觸發回滾 |

### 4.3 交易狀態記錄功能

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-011 | 呼叫前狀態記錄 | 微服務被呼叫時，記錄狀態 U |
| FR-012 | 成功狀態記錄 | 微服務正確回應時，記錄狀態 S |
| FR-013 | 失敗狀態記錄 | 微服務回應失敗時，記錄狀態 F |
| FR-014 | 回滾狀態記錄 | 執行回滾 API 後，記錄狀態 R |
| FR-015 | 完成狀態記錄 | 回滾流程全部完成後，記錄狀態 D |
| FR-016 | 回滾失敗記錄 | 回滾重試 5 次仍失敗，記錄狀態 RF |

### 4.4 補償機制功能

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-017 | 即時失敗回滾 | 收到失敗回應時，立即回滾已成功(S)的微服務 |
| FR-018 | 超時回滾 | U 狀態超過設定時間觸發回滾 |
| FR-019 | 回滾順序控制 | 回滾順序為成功順序的反向 |
| FR-020 | 回滾重試機制 | 回滾失敗時重試 5 次（可配置） |
| FR-021 | 回滾失敗通知 | 重試失敗後發送 Email 通知（開發階段模擬） |
| FR-022 | Rollback 冪等 | 各微服務 rollback API 支援冪等，無對應交易也回傳成功 |

### 4.5 WebSocket 通知功能

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-023 | WebSocket 連線 | 支援客戶端建立 WebSocket 連線 |
| FR-024 | 狀態推送 | 每個步驟狀態變更時推送通知 |
| FR-025 | 推送內容 | 包含 txId, orderId, status, currentStep, message, timestamp |

### 4.6 Saga 恢復功能

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-026 | 啟動掃描 | 服務啟動時掃描未完成交易 |
| FR-027 | Thread 恢復 | 為未完成交易重新啟動 Checker Thread |

### 4.7 管理 API 功能

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-028 | 查詢服務順序 | GET API 查詢目前生效的服務呼叫順序 |
| FR-029 | 修改服務順序 | PUT API 儲存新順序（暫存，未生效） |
| FR-030 | 觸發順序生效 | POST API 觸發暫存順序生效 |
| FR-031 | 查詢超時設定 | GET API 查詢各服務超時時間 |
| FR-032 | 修改超時設定 | PUT API 儲存新超時設定（暫存，未生效） |
| FR-033 | 觸發超時生效 | POST API 觸發暫存超時設定生效 |

### 4.8 資料一致性功能

| 功能編號 | 功能名稱 | 說明 |
|----------|----------|------|
| FR-034 | Outbox Pattern | 業務資料與 Outbox 事件在同一 DB Transaction 完成 |
| FR-035 | Event Sourcing | 所有狀態變更以 INSERT 方式記錄，不做 UPDATE |

---

## 5. 交易狀態定義

### 5.1 狀態碼

| 狀態碼 | 名稱 | 說明 |
|--------|------|------|
| U | Uncommitted (在途) | 微服務已被呼叫，尚未收到回應 |
| S | Success (成功) | 微服務回應成功 |
| F | Failed (失敗) | 微服務回應失敗 |
| R | Rolled back (回滾) | 已執行回滾 API |
| D | Done (完成) | 回滾流程全部完成 |
| RF | Rollback Failed (回滾失敗) | 回滾重試失敗，需人工介入 |

### 5.2 狀態轉換規則

```
                    成功回應
┌─────┐ ──────────────────────────────────► ┌─────┐
│  U  │                                     │  S  │
└─────┘                                     └─────┘
   │                                           │
   │ 失敗回應                                  │ 後續服務失敗/超時
   ▼                                           ▼
┌─────┐                                     ┌─────┐
│  F  │                                     │  R  │
└─────┘                                     └─────┘
                                               │
                    回滾全部完成               │
                ┌──────────────────────────────┘
                ▼
             ┌─────┐
             │  D  │
             └─────┘

回滾重試失敗
┌─────┐
│ RF  │ → 需人工介入
└─────┘
```

### 5.3 Checker Thread 停止條件

| 條件 | 最終狀態 | 說明 |
|------|----------|------|
| 三個微服務皆為 S | S, S, S | 交易成功 |
| 回滾流程完成 | 含 D | 交易失敗但已完成回滾 |
| 回滾失敗 | 含 RF | 需人工介入 |

---

## 6. 交易狀態資料表規格

### 6.1 欄位定義

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|----------|----------|------|------|
| id | BIGINT | Y | 主鍵，自動遞增 |
| tx_id | VARCHAR(36) | Y | 交易識別碼 (UUID) |
| order_id | VARCHAR(36) | Y | 關聯原始訂單編號 |
| service_name | VARCHAR(50) | Y | 微服務名稱 |
| status | CHAR(2) | Y | 執行狀態 (U/S/F/R/D/RF) |
| error_message | VARCHAR(500) | N | F / RF 狀態的錯誤訊息 |
| retry_count | INT | N | 回滾重試次數 |
| created_at | TIMESTAMP | Y | 記錄建立時間戳記 |
| notified_at | TIMESTAMP | N | RF 狀態發送通知的時間 |

### 6.2 索引設計

- 主鍵索引：`id`
- 複合索引：`(tx_id, service_name, status)`
- 時間索引：`(status, created_at)` - 用於超時查詢
- 訂單索引：`(order_id)`

---

## 7. API 規格

### 7.1 訂單確認 API

```
POST /api/v1/orders/confirm
```

**Request Body**:
```json
{
  "orderId": "ORD-20260101-001",
  "customerId": "CUST-001",
  "items": [
    {
      "productId": "IPHONE-15-PRO",
      "quantity": 1,
      "unitPrice": 36900
    }
  ],
  "totalAmount": 36900
}
```

**Response (202 Accepted)**:
```json
{
  "txId": "550e8400-e29b-41d4-a716-446655440000",
  "orderId": "ORD-20260101-001",
  "status": "PROCESSING",
  "message": "訂單已受理，處理中",
  "websocketUrl": "/ws/orders/550e8400-e29b-41d4-a716-446655440000"
}
```

### 7.2 WebSocket 推送格式

**Endpoint**: `/ws/orders/{txId}`

**推送訊息格式**:
```json
{
  "txId": "550e8400-e29b-41d4-a716-446655440000",
  "orderId": "ORD-20260101-001",
  "status": "PROCESSING",
  "currentStep": "CREDIT_CARD",
  "message": "信用卡扣款成功",
  "timestamp": "2026-01-01T10:30:00Z"
}
```

**status 可能值**:

| 值 | 說明 |
|----|------|
| PROCESSING | 處理中 |
| COMPLETED | 交易完成 |
| FAILED | 交易失敗 |
| ROLLING_BACK | 回滾中 |
| ROLLED_BACK | 已回滾 |
| ROLLBACK_FAILED | 回滾失敗 |

### 7.3 微服務交易通知 API

每個微服務需實作以下 API：

**交易通知 API**:
```
POST /api/v1/{service}/notify
```

**回滾 API**（需支援冪等，無對應交易也回傳成功）:
```
POST /api/v1/{service}/rollback
```

| 微服務 | 交易通知 Endpoint | 回滾 Endpoint |
|--------|-------------------|---------------|
| 信用卡 | `/api/v1/credit-card/notify` | `/api/v1/credit-card/rollback` |
| 倉管 | `/api/v1/inventory/notify` | `/api/v1/inventory/rollback` |
| 物流 | `/api/v1/logistics/notify` | `/api/v1/logistics/rollback` |

### 7.4 管理 API - 服務順序

**查詢服務順序**:
```
GET /api/v1/admin/saga/service-order
```

**Response**:
```json
{
  "active": [
    { "order": 1, "name": "CREDIT_CARD", "notifyUrl": "...", "rollbackUrl": "..." },
    { "order": 2, "name": "INVENTORY", "notifyUrl": "...", "rollbackUrl": "..." },
    { "order": 3, "name": "LOGISTICS", "notifyUrl": "...", "rollbackUrl": "..." }
  ],
  "pending": null
}
```

**修改服務順序**:
```
PUT /api/v1/admin/saga/service-order
```

**Request Body**:
```json
{
  "services": [
    { "order": 1, "name": "CREDIT_CARD", "notifyUrl": "...", "rollbackUrl": "..." },
    { "order": 2, "name": "INVENTORY", "notifyUrl": "...", "rollbackUrl": "..." },
    { "order": 3, "name": "LOGISTICS", "notifyUrl": "...", "rollbackUrl": "..." }
  ]
}
```

**觸發生效**:
```
POST /api/v1/admin/saga/service-order/apply
```

### 7.5 管理 API - 超時設定

**查詢超時設定**:
```
GET /api/v1/admin/saga/timeout
```

**Response**:
```json
{
  "active": {
    "CREDIT_CARD": 30,
    "INVENTORY": 60,
    "LOGISTICS": 120
  },
  "pending": null
}
```

**修改超時設定**:
```
PUT /api/v1/admin/saga/timeout
```

**Request Body**:
```json
{
  "timeouts": {
    "CREDIT_CARD": 30,
    "INVENTORY": 60,
    "LOGISTICS": 120
  }
}
```

**觸發生效**:
```
POST /api/v1/admin/saga/timeout/apply
```

---

## 8. 業務規則

### 8.1 呼叫順序規則

1. 訂單服務收到確認請求後，產生 TxID
2. 寫入 Outbox 事件（同一 DB Transaction）
3. 回應 202 Accepted
4. 啟動專屬 Checker Thread
5. Outbox Poller（單一）依可配置順序呼叫微服務
6. 預設順序：信用卡 → 倉管 → 物流
7. 每個微服務必須正確回應後，才能呼叫下一個
8. 全部成功後，三個微服務狀態皆為 S

### 8.2 回滾規則

1. 任一微服務回應失敗（F）或超時（U 過久），觸發回滾流程
2. 回滾對象：同一 TxID 且狀態為 S 的微服務
3. 回滾順序：成功順序的反向（物流 → 倉管 → 信用卡）
4. 每個回滾呼叫後，記錄狀態 R
5. 全部回滾完成後，記錄狀態 D
6. 回滾 API 需支援冪等：無對應交易也回傳成功

### 8.3 回滾重試規則

1. 回滾 API 失敗時，最多重試 5 次（可配置）
2. 重試 5 次仍失敗，記錄狀態 RF
3. 記錄錯誤訊息至 error_message 欄位
4. 發送 Email 通知管理人員
5. 記錄通知時間至 notified_at 欄位
6. 開發階段：Email 以模擬方式實作，保留可配置介面

### 8.4 超時規則

1. 各微服務可分別設定超時時間
2. 預設超時時間：
   - 信用卡：30 秒
   - 倉管：60 秒
   - 物流：120 秒
3. Checker Thread 監控各服務的 U 狀態時間
4. 超時後觸發回滾流程

### 8.5 Checker Thread 規則

1. 每筆訂單啟動一個專屬 Checker Thread
2. 持續監控該 TxID 的交易狀態
3. 停止條件：
   - 三個微服務皆為 S（成功）
   - 回滾流程完成，記錄 D
   - 回滾失敗，記錄 RF
4. 不需要分散式鎖（每訂單單一 Thread）

### 8.6 服務恢復規則

1. 訂單服務啟動時，掃描所有未完成交易
2. 未完成定義：狀態非（全 S / 含 D / 含 RF）
3. 為每筆未完成交易重新啟動 Checker Thread
4. 繼續執行剩餘流程或回滾

---

## 9. 非功能需求

### 9.1 效能需求

| 項目 | 指標 |
|------|------|
| 訂單受理回應時間 | < 200ms（寫入 Outbox） |
| 單筆訂單處理時間 | < 3 秒（不含微服務回應時間） |
| 併發訂單處理 | 支援 100 筆/秒 |

### 9.2 可用性需求

| 項目 | 指標 |
|------|------|
| 系統可用性 | 99.9% |
| 交易狀態查詢 | 即時可查 |
| 服務重啟恢復 | 自動恢復未完成交易 |

### 9.3 可觀測性需求

| 項目 | 說明 |
|------|------|
| Metrics | Saga 成功率、失敗率、平均處理時間、超時率 |
| Logging | 結構化日誌，記錄每個步驟的執行狀態 |
| Tracing | 分散式追蹤（Micrometer Tracing） |

---

## 10. 詞彙表

| 術語 | 定義 |
|------|------|
| TxID | Transaction ID，交易識別碼，使用 UUID 格式 |
| Saga Pattern | 分散式交易管理模式，透過補償機制確保最終一致性 |
| Orchestration | 編排模式，由中央協調器控制服務呼叫順序 |
| Outbox Pattern | 確保 DB 操作與訊息處理原子性的設計模式 |
| Event Sourcing | 以事件序列記錄狀態變更的設計模式 |
| Checker Thread | 每筆訂單專屬的監控執行緒，負責監控交易狀態與超時 |
| Poller | 輪詢程式，定期讀取 Outbox 並處理事件 |

---

## 11. 附錄

### 11.1 異步交易流程圖

```
┌──────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│  Client  │    │   Order    │    │ CreditCard │    │ Inventory  │    │ Logistics  │
└────┬─────┘    └─────┬──────┘    └─────┬──────┘    └─────┬──────┘    └─────┬──────┘
     │                │                 │                 │                 │
     │ POST /confirm  │                 │                 │                 │
     │───────────────►│                 │                 │                 │
     │                │                 │                 │                 │
     │                │ [寫入 Outbox]   │                 │                 │
     │                │ [啟動 Checker]  │                 │                 │
     │                │                 │                 │                 │
     │  202 Accepted  │                 │                 │                 │
     │◄───────────────│                 │                 │                 │
     │                │                 │                 │                 │
     │  [WebSocket]   │ ══════════════════════════════════════════════════ │
     │◄═══════════════│ Poller 處理    │                 │                 │
     │                │ [記錄 U]        │                 │                 │
     │                │ POST /notify    │                 │                 │
     │                │────────────────►│                 │                 │
     │                │    200 OK       │                 │                 │
     │                │◄────────────────│                 │                 │
     │  [推送: 扣款成功]                │                 │                 │
     │◄═══════════════│ [記錄 S]        │                 │                 │
     │                │                 │                 │                 │
     │                │ [記錄 U]        │ POST /notify    │                 │
     │                │─────────────────────────────────►│                 │
     │                │                 │    200 OK       │                 │
     │                │◄─────────────────────────────────│                 │
     │  [推送: 庫存預留成功]            │                 │                 │
     │◄═══════════════│ [記錄 S]        │                 │                 │
     │                │                 │                 │                 │
     │                │ [記錄 U]        │                 │ POST /notify    │
     │                │────────────────────────────────────────────────────►│
     │                │                 │                 │    200 OK       │
     │                │◄────────────────────────────────────────────────────│
     │  [推送: 出貨排程成功]            │                 │                 │
     │◄═══════════════│ [記錄 S]        │                 │                 │
     │                │ [Checker 停止]  │                 │                 │
     │  [推送: 訂單完成]                │                 │                 │
     │◄═══════════════│                 │                 │                 │
```

### 11.2 回滾流程圖

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│   Order    │    │ CreditCard │    │ Inventory  │    │ Logistics  │
└─────┬──────┘    └─────┬──────┘    └─────┬──────┘    └─────┬──────┘
      │                 │                 │                 │
      │                 │ [狀態: S]       │ [狀態: S]       │
      │                 │                 │                 │
      │ POST /notify    │                 │                 │
      │─────────────────────────────────────────────────────►│
      │                 │                 │    500 Error    │
      │◄─────────────────────────────────────────────────────│
      │ [記錄 F]        │                 │                 │
      │                 │                 │                 │
      │ ══════════════ 反向回滾 ══════════════               │
      │                 │                 │                 │
      │                 │ POST /rollback  │                 │
      │─────────────────────────────────►│                 │
      │                 │    200 OK       │                 │
      │◄─────────────────────────────────│                 │
      │ [記錄 R]        │                 │                 │
      │                 │                 │                 │
      │ POST /rollback  │                 │                 │
      │────────────────►│                 │                 │
      │    200 OK       │                 │                 │
      │◄────────────────│                 │                 │
      │ [記錄 R]        │                 │                 │
      │ [記錄 D]        │                 │                 │
      │ [Checker 停止]  │                 │                 │
```

### 11.3 管理 API 流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    服務順序 / 超時設定 管理                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   GET (查詢)          PUT (修改)         POST /apply (生效)     │
│       │                   │                    │                │
│       ▼                   ▼                    ▼                │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐           │
│  │ Active  │         │ Pending │ ──────► │ Active  │           │
│  │ 設定區  │         │ 暫存區  │  生效   │ 設定區  │           │
│  └─────────┘         └─────────┘         └─────────┘           │
│       │                                        │                │
│       └────────────────────────────────────────┘                │
│                    新訂單使用 Active 設定                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
